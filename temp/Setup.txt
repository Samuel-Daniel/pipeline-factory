############################################################
##### 
##### SETUP DO PROTUDO
#####
##### Estas Stacks devem ser criadas pela Landing Zone, no Setup de um Produto
#####
#####
##### Variáveis:
##### ProducteName="iti"
##### FeatureName="onboarding"
##### DevToolsAccount="935187548418"
##### DevAccount="255538382414"
##### HomologAccount="450454659259"
##### ProdAccount="754190108602"
#####
#####
##### Shared Accounts
##### DevOpsAccount="300003219274"
##### ArchitectureAccount="000000000000"

### Estas Roles devem ser criadas pela Landing Zone - Cria RoleCrossAccount [DevAccount, HomologAccount, ProdAccount, DevOpsAccount]

aws cloudformation deploy --stack-name RoleCrossAccount --template-file General/SetupCrossAccount.yaml --capabilities CAPABILITY_NAMED_IAM \
--parameter-overrides DevToolsAccount=$DevToolsAccount --profile <NomeDoProfile>

### Setup DevTools [DevTools]
aws cloudformation deploy --stack-name Setup-DevTools  --template-file DevTools-Account/Setup-DevTools.yaml --capabilities CAPABILITY_NAMED_IAM \
--parameter-overrides DevOpsAccount=$DevOpsAccount DevAccount=$DevAccount HomologAccount=$HomologAccount ProdAccount=$ProdAccount \
--profile DevToolsAccount

# a stack abaixo será criada pelo pipeline
aws cloudformation deploy --stack-name $FeatureName --template-file DevTools-Account/SetupProduto.yaml --capabilities CAPABILITY_NAMED_IAM \
--parameter-overrides DevOpsAccount=$DevOpsAccount DevAccount=$DevAccount HomologAccount=$HomologAccount ProdAccount=$ProdAccount FeatureName=$FeatureName \
--profile DevToolsAccount


############################################################
##### 
##### SETUP DO MICRO SERVIÇO
#####

DevTools-Account/CriaRepo.yaml 
MicroServiceName="ms01"
aws cloudformation deploy --stack-name $FeatureName-$MicroServiceName --template-file DevTools-Account/CriaRepo.yaml --capabilities CAPABILITY_NAMED_IAM --parameter-overrides MicroServiceName=$MicroServiceName --profile DevToolsAccount

Pega o nome do Bucket
BucketArtifact=$(aws cloudformation describe-stacks --stack-name onboarding --query 'Stacks[0].Outputs[?OutputKey==`BucketArtifact`].OutputValue' --output text --profile DevToolsAccount)

Pega o KMSKeyArn
KMSKeyArn=$(aws cloudformation describe-stacks --stack-name onboarding --query 'Stacks[0].Outputs[?OutputKey==`KMSKeyArn`].OutputValue' --output text --profile DevToolsAccount)

Upload do template 
aws s3 cp DevTools-Account/SetupPipeline.yaml s3://$BucketArtifact/cloudformation/$MicroServiceName/SetupPipeline.yaml --profile DevToolsAccount

#aws s3 cp DevTools-Account/SetupPipeline.yaml s3://cloudformation-$DevToolsAccount/$MicroServiceName/SetupPipeline.yaml --profile DevToolsAccount
# aws s3 cp DevTools-Account/SetupPipeline.yaml s3://$BucketArtifact/cloudformation/$MicroServiceName/SetupPipeline.yaml --sse aws:kms --sse-kms-key-id $KMSKeyArn --profile itau-lab-devtools



#########################
TO DO 

Criar SSM com a URL dos templates de Cfn para Pipeline
Criar SSM com o nome do template para o Micro SERVIÇO




#########################



DevTools-Account/SetupPipeline.yaml {master}
BranchName="master"
CD="true"
aws cloudformation deploy --stack-name $FeatureName-$MicroServiceName-$BranchName --template-file DevTools-Account/SetupPipeline.yaml --capabilities CAPABILITY_NAMED_IAM --parameter-overrides MicroServiceName=$MicroServiceName BranchName=$BranchName CD=$CD --profile DevToolsAccount

DevTools-Account/SetupPipeline.yaml {develop}
BranchName="develop"
CD="true"
aws cloudformation deploy --stack-name $FeatureName-$MicroServiceName-$BranchName --template-file DevTools-Account/SetupPipeline.yaml --capabilities CAPABILITY_NAMED_IAM --parameter-overrides MicroServiceName=$MicroServiceName BranchName=$BranchName CD=$CD --profile DevToolsAccount



####################################################################
buenoh-at-935187548418
kUZ5fAeyJP38quiNT/iV0izEGhtP5eZOrOOawinG3w8=
 https://itau-devsecops.signin.aws.amazon.com/console